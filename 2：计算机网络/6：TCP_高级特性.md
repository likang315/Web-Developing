### TCP 高级特性

------

##### 1：滑动窗口协议（Sliding Window Protocol）

​	TCP协议的一种应用，用于网络数据传输时的流量控制的技术，以避免拥塞的发生 该协议**允许发送方在停止并等待确认前发送多个数据分组**。由于发送方不必每发一个分组就停下来等待确认，因此该协议可以加速数据的传输，提高网络吞吐量

运用TCP报文段中的窗口大小字段来控制，发送方的发送窗口不可以大于接收方发回的窗口大小

[![发送窗口_1.jpg](https://github.com/likang315/Web-Developing/raw/master/Web%20%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/2%EF%BC%9A%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/5%EF%BC%9A%E4%BC%A0%E8%BE%93%E5%B1%82/%E5%8F%91%E9%80%81%E7%AA%97%E5%8F%A3_1.jpg?raw=true)](https://github.com/likang315/Web-Developing/blob/master/Web 知识体系/2：计算机网络/5：传输层/发送窗口_1.jpg?raw=true)

[![发送窗口_2.jpg](https://github.com/likang315/Web-Developing/raw/master/Web%20%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/2%EF%BC%9A%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/5%EF%BC%9A%E4%BC%A0%E8%BE%93%E5%B1%82/%E5%8F%91%E9%80%81%E7%AA%97%E5%8F%A3_2.jpg?raw=true)](https://github.com/likang315/Web-Developing/blob/master/Web 知识体系/2：计算机网络/5：传输层/发送窗口_2.jpg?raw=true)

### 发送端：

###### 1：已发送确认

数据流中最早的字节已经发送并得到确认

###### 2：已发送但未收到确认

已发送但尚未得到确认的字节。发送方在确认之前，不认为这些数据已经被处理

###### 3：允许发送但尚未发送

数据已经被加载到缓存中(窗口）

###### 4：不允许发送

数据属于未发送，同时接收端也不允许发送的，因为这些数据已经超出了发送端所接收的范围，发送端缓存范围

##### 发送窗口：接收方允许发送方一次能容纳的未确认的字节数，决定了发送方允许传送的字节数,当收到接收方新的ACK（确认号）对于发送窗口中后续字节的确认时，滑动窗口

### 接收端：

###### 1：已接收

###### 2：未接收准备接收（接受窗口）

###### 3：未接收并未准备接收（由于ACK直接由TCP协议栈回复，默认无应用延迟，不存在 "已接收未回复ACK"）

**TCP 全双工传输，因此通信的双方都拥有两个滑动窗口，一个用于接受数据，称之为接收窗口；一个用于发送数据，称之为发送窗口**

### 接收窗口 >= 发送窗口

### 应用：

###### 1：停止-等待协议

此时接受方的窗口和发送方的窗口大小都是1bit，所以也叫**1比特滑动窗口协议**

发送方这时自然发送每次只能发送一个，并且必须等待这个数据包的ACK，才能发送下一个，但是效率太低，一直等待

###### 2：回退n步协议

发送方在发完一个数据帧后，不停下来等待应答帧，而是连续发送若干个数据帧，即使在连续发送过程中收到了接收方发来的应答帧，也可以继续发送。且发送方在每发送完一个数据帧时都要**设置超时定时器。只要在所设置的超时时间内仍收到确认帧，就要重发相应的数据帧，回退了n 步**

一旦网络情况糟糕，则会导致大量数据重发，反而不如上面的停等协议

###### 3：选择重传协议

当出现错误帧后，总是要重发该帧之后的所有帧，所以**接收端总会缓存所有收到的帧，当某个帧出现错误时，只会要求重传这一个帧**，只有当某个序号后的所有帧都正确收到后，才会一起提交给上层应用

重传协议的缺点：在于接受端需要更多的缓存

### 2：拥塞机制

某一时刻，若对网络中某一个资源的需求超过了该资源所能提供的负载，网络的性能就会变坏，这种情况就叫做拥塞

拥塞控制：就是防止过多的数据注入网络中，这样可以使网络中的路由器或者链路不会**导致过载**,拥塞控制是**一个全局性的过程，和流量控制不同，流量控制指点对点通信量的控制**

###### 发送方维持一个叫拥塞窗口（cwnd）的状态变量，拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化

发送方让自己**的发送窗口等于拥塞窗口，**另外考虑到接受方的接收能力，发送窗口可能小于拥塞窗口

#### 慢开始算法

就是不要一开始就发送大量的数据，**先探测一下网络的拥塞程度**，也就是由小到大逐渐增加拥塞窗口的大小

为了防止拥塞窗口(cwnd)增长过大引起网络拥塞，还需设置一个慢开始门限(ssthresh)状态变量 当cwnd < ssthresh ,慢开始 当cwnd = ssthresh ,慢开始和拥塞避免算法任意 当cwnd > ssthresh ,拥塞避免算法

#### 拥塞避免算法

让拥塞窗口缓慢增长，即**每经过一个往返时间 RTT 就把发送方的拥塞窗口cwnd 加 1,不是加倍**，这样拥塞窗口按线性规律缓慢增长

**无论是在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络拥塞,就把慢开始门限设置为出现拥塞时的发送窗口大小的一半，然后把拥塞窗口设置为1，执行慢开始算法**

### 3：快重传和快恢复

##### 快重传

要求接收方在**收到一个失序的报文时就立即发出重复确认**（使发送尽早知道有报文段没有到达对方）而不要等到自己发送数据时捎带确认

一般来说，重传发生在超时之后，**但是**如果发送端接收到3个以上的重复 确认ACK报文，就应该意识到，需要重新传递,这个机制不需要等到重传定时器溢出，所以叫做快重传

##### 而快重传以后，因为走的不是慢开始而是拥塞避免算法，所以叫快速恢复算法

### 快重传和快恢复旨在：快速恢复丢失的数据包