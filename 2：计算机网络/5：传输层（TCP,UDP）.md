### 传输层：TCP/UDP

------

##### 1：TCP协议

​	当应用程序希望通过 TCP 与网络中另一个应用程序通信时，它会发送一个通信请求；这个请求必须被送到一个确切的地址（IP地址），TCP通信负责网络中进程间的通信

- TCP：面向连接，可靠的通信协议
- UDP：面向无连接，不可靠的通信协议
- 端口号（Port）：每个报文中会携带源端口，目的端口号用于标示网络中唯一的进程
  - 0—1024：知名端口，用于公共服务的
  - 1024—49151：注册端口
  - 49152—65535：私有端口
- 套接字：< IP port >

##### 2：TCP 报文格式

![TCP报文格式](/Users/likang/Code/Git/Web-Developing/2：计算机网络/传输层/TCP报文格式.png)

- 序号：为数据流中每个字节都有一个编号，由发送端决定，用于描述报文端中首字节在整个字节流中的位置
- 确认号：由接受端决定，代表已经正确的接受了确认号之前的所有字节
- 窗口大小：接受端确定，实现基于接受者的流量控制的机制
- Flag：6bit，标志位，用于连接管理

##### 3：TCP 和 UDP 的区别

1. TCP面向连接的，UDP面向无连接的

2. TCP提供可靠的服务，UDP尽力而为的协议，不保证可靠性

   1. ###### 头部检验和

      - TCP 检验和的计算与UDP一样，在计算时要加上12byte的伪首部，检验范围包括TCP首部及数据部分，但是UDP的检验和字段为可选的，而TCP中是必须有的
      - 校验方法：在发送方将整个报文段**分为多个16位的段，然后将所有段进行反码相加，将结果存放在检验和字段**中，接收方用相同的方法进行计算，如最终结果为检验字段所有位是全1则正确（UDP中为0是正确），否则存在错误

   2. ###### 序号 

      - TCP将每个字节的数据都进行了编号就是序列号
      - 序列号的作用： 
        1. 丢失某个字节时，可以立即知道
        2. 保证数据的按序到达 
        3. 提高效率，可实现多次发送，一次确认

   3. 确认应答机制（ ACK=1 ） 

      - TCP通过确认应答机制实现可靠的数据传输，在TCP的首部中有一个标志位(ACK)ß，此标志位表示确认号是否有效

   4. 超时重传机制 

      - 当报文发出后在一定的时间内未收到接收方的确认，发送方就会进行重传（通常是在发出报文段后设定一个定时器，到点了还没有收到应答则进行重传）

   5. 流量控制 （滑动窗口协议）

   6. 拥塞控制

   7. 连接管理机制 （三握，四挥）

3. TCP对系统资源需求较多，UDP对系统资源要求少

4. TCP与UDP头部所占字节树不同，TCP：20个字节，UDP：8个字节

##### 4：三次握手

​	可能数据还没有发送完，就直接关闭

![三次握手](/Users/likang/Code/Git/Web-Developing/2：计算机网络/传输层/三次握手.png)

###### 为什么需要第三次握手

​	防止已失效的请求建立请求报文段突然又传送到了服务端而产生连接的误判

- 客户端发送了一个建立连接请求报文段A到服务端，但是在某些网络节点上长时间滞留了，而后客户端又超时重发了一个建立连接请求报文段B到服务端，而后正常建立连接，数据传输完毕，并释放了连接。但是请求报文段A延迟了一段时间后，又到了服务端，这本是一个早已失效的报文段，但是服务端收到后会误以为客户端又发出了一次连接请求，于是向客户端发出确认报文段，并同意建立连接
- 问题是：假如这里没有三次握手，这时服务端只要发送了确认，新的连接就建立了，但由于客户端没有发出建立连接的请求，因此不会理会服务端的确认，也不会向服务端发送数据，而服务端却认为新的连接已经建立了，并在 一直等待客户端发送数据，这样服务端就会一直等待下去，直到超出保活计数器的设定值，而将客户端判定为出了问题，才会关闭这个连接

##### 5： MSL(maximum segment lifetime)：最大报文生命周期

​	MSL是任何IP数据报(TTL)能够在网络中存活的最长时间，时间是有限的，因为每个数据报都含有一个限跳（hop limit）的8位字段，它的最大值是255，尽管这个跳数限制而不是真正的时间限制，我们仍然假设最大限跳的分组在网络中存在的时间不可能超过MSL秒，MSL的具体值通常为30秒或者是2分钟

##### 6：四次挥手

![四次挥手](/Users/likang/Code/Git/Web-Developing/2：计算机网络/传输层/四次挥手.png)

- 三握状态：SYN-SENT(同步已发送)—>SYN-RCVD(同步已收到)—>ESTABLISHED（连接状态）
- 四挥状态：ESTABLISHED—>FIN-WAIT-1（终止等待1）状态—>服务端CLOSE-WAIT状态—>FIN-WAIT-2    —>LAST-ACK（最后确认）状态—>TIME-WAIT状态—>CLOSED

###### TIME_WAIT 状态

- 在四次挥手的过程中，主动关闭方在四次挥手的最后一个ACK发送之后会变成TIME_WAIT状态，这个状态维持2MSL时间，从TIME_WAIT状态到CLOSED状态有一个超时设置，这个超时设置是2MSL(端口占用时间)


###### 为什么存在TIME_WAIT状态（时间等待状态）

1. 实现可靠的TCP全双工连接终止
   - 由于网络的问题，可能最后一次ack报文不一定被服务器收到，此时服务器会重新发送FIN报文，所以TIME_WAIT状态是用来重新发送可能丢失的 ACK 报文
2. 保证让迟来的TCP报文段有足够的时间被识别丢弃
   - 如果不存在TIME_WAIT 状态，则应用程序能够立即建立一个和刚关闭的连接相似的连接，端口可能还被占用，新的连接可能接受到原来连接携带的报文，存在TIME_WAIT, 我们将无法立即使用该连接占用着的端口来建立一个连接
3. TIME_WAIT=2MSL，在网络上一个报文的来回时间，能够确认客户端可以收到服务器的重新发送的FIN报文

##### 7：FLAG 标志位

1. URG：紧急 
2. ACK：确认应答，确认号
3. PUSH：数据包立即发送 
4. RST：中断一个连接
5. SYN：开始建立连接请求  
6. FIN：结束会话 

##### 8：TTL（time-to-live）：生存周期字段

​	在IP首部中的8位字段生命期中，设置了**数据报可以经过的最多路由器数**，制定了数据报的生存时间，路由数为 0 则数据报将被丢弃，同时发送ICMP消息报文通知源主机错误信息

- RTT（round-trip-time）：客户到服务器往返所花时间
- TCP超时与重传中最重要的部分就是对一个给定连接的往返时间 RTT 的测量
- TTL与 MSL的关系：**MSL要大于等于TTL**

##### 9：发送URL请求，经历了那些过程

1. DNS 域名解析
2. 三次握手
3. HTTP请求
4. HTTP响应
5. 四次挥手
6. 渲染页面




